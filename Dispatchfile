#!cue

resource "src-git": {
  type: "git"
  param url: "$(context.git.url)"
  param revision: "$(context.git.commit)"
}

task "build": {
  inputs: ["src-git", "maven-cache"]
  outputs: ["maven-cache"]

  steps: [
    {
      name: "restore-cache"
      image: "meltwater/drone-cache"
      env: {
        AWS_ACCESS_KEY_ID: "abcd"
        AWS_SECRET_ACCESS_KEY: "defghijk"
        PLUGIN_PATH_STYLE: "true"
        PLUGIN_MOUNT: "/root/.m2"
        PLUGIN_RESTORE: "true"
        PLUGIN_BUCKET: "artifacts"
        PLUGIN_ENDPOINT: "http://pumpkin-minio.pumpkin"
      }
    },
    {
      name: "build"
      image: "maven:3.6-jdk-8-slim"
      command: [ "mvn", "verify" ]
      workingDir: "/workspace/src-git"
    }
  ]
}

actions: [
  {
    tasks: ["build"]
    on push branches: ["master"]
  }
]