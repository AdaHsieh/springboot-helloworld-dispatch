#!cue

resource "src-git": {
  type: "git"
  param url: "$(context.git.url)"
  param revision: "$(context.git.commit)"
}

task "build": {
  inputs: ["src-git"]

  volumes: [
    {
      name: "cache-volume"
      emptyDir: {}
    }
  ]

  steps: [
    {
      name: "restore-cache"
      image: "meltwater/drone-cache"
      env: [
        {
          name: "AWS_ACCESS_KEY_ID"
          valueFrom secretKeyRef name: "s3-config"
          valueFrom secretKeyRef key: "AWS_ACCESS_KEY_ID"
        },
        {
          name: "AWS_SECRET_ACCESS_KEY"
          valueFrom secretKeyRef name: "s3-config"
          valueFrom secretKeyRef key: "AWS_SECRET_ACCESS_KEY"
        },
        {
          name: "PLUGIN_PATH_STYLE"
          value: "true"
        },
        {
          name: "PLUGIN_MOUNT"
          value: "/root/.m2"
        },
        {
          name: "PLUGIN_RESTORE"
          value: "true"
        },
        {
          name: "PLUGIN_BUCKET"
          value: "artifacts"
        },
        {
          name: "PLUGIN_ENDPOINT"
          value: "http://s3-us-east-1.pumpkin"
        },
        {
          name: "PLUGIN_REGION"
          value: "us-east-1"
        }
      ]
      volumeMounts: [
        {
          name: "cache-volume"
          mountPath: "/root/.m2"
        }
      ]
    },
    {
      name: "build"
      image: "maven:3.6-jdk-8-slim"
      command: [ "mvn", "verify" ]
      workingDir: "/workspace/src-git"
      volumeMounts: [
        {
          name: "cache-volume"
          mountPath: "/root/.m2"
        }
      ]
    },
    {
      name: "rebuild-cache"
      image: "meltwater/drone-cache"
      env: [
        {
          name: "AWS_ACCESS_KEY_ID"
          valueFrom secretKeyRef name: "s3-config"
          valueFrom secretKeyRef key: "AWS_ACCESS_KEY_ID"
        },
        {
          name: "AWS_SECRET_ACCESS_KEY"
          valueFrom secretKeyRef name: "s3-config"
          valueFrom secretKeyRef key: "AWS_SECRET_ACCESS_KEY"
        },
        {
          name: "PLUGIN_PATH_STYLE"
          value: "true"
        },
        {
          name: "PLUGIN_MOUNT"
          value: "/root/.m2"
        },
        {
          name: "PLUGIN_RESTORE"
          value: "false"
        },
        {
          name: "PLUGIN_REBUILD"
          value: "true"
        },
        {
          name: "PLUGIN_BUCKET"
          value: "artifacts"
        },
        {
          name: "PLUGIN_ENDPOINT"
          value: "http://s3-us-east-1.pumpkin"
        },
        {
          name: "PLUGIN_REGION"
          value: "us-east-1"
        }
      ]

      volumeMounts: [
        {
          name: "cache-volume"
          mountPath: "/root/.m2"
        }
      ]
    }
  ]
}

actions: [
  {
    tasks: ["build"]
    on push branches: ["master"]
  }
]